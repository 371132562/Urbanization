name: 创建Windows Electron客户端
on:
  push:
    branches:
      - master

# 并发控制：自动取消旧的、正在进行中的工作流
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 授予工作流写权限，以便它可以创建 Release
permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest # 使用Windows环境进行构建
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: |
          pnpm install --allow-build electron-builder --allow-build better-sqlite3 --allow-build @prisma/client
          pnpm approve-builds
        
      - name: 构建和打包
        run: |
          cd electron
          pnpm build
          
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: Urbanization-Desktop
          path: electron/release/win-unpacked
          retention-days: 30