name: 创建electron客户端
on:
  push:
    branches:
      - master

# 并发控制：自动取消旧的、正在进行中的工作流
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 授予工作流写权限，以便它可以创建 Release
permissions:
  contents: write


jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install
        
      - name: 安装Wine和依赖
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y wine wine32 wine64 libwine-dev fonts-wine
          sudo apt-get install -y mono-complete
        
      - name: 设置虚拟显示环境
        run: |
          export DISPLAY=:99.0
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          
      - name: 构建和打包
        run: |
          cd electron
          export DISPLAY=:99.0
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          pnpm build
        env:
          DISPLAY: :99.0
          
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: Urbanization-Desktop
          path: electron/release/win-unpacked
          retention-days: 30